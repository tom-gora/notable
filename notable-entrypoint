#!/bin/bash
set -e

CYAN="\\033[36m"
BLUE="\\033[34m"
RESET="\\033[0m"

echo -e "${CYAN}[$(date +'%d-%b-%Y %H:%M:%S')] App service init script called.${RESET}"

printf "\n
\e[48;2;0;0;0m    \e[38;2;230;0;0;48;2;0;0;0m▄\e[38;2;246;0;0;48;2;0;0;0m▄\e[38;2;255;0;0;48;2;0;0;0m▄\e[48;2;0;0;0m    \e[38;2;63;0;0;48;2;0;0;0m▄\e[38;2;255;0;0;48;2;0;0;0m▄▄▄\e[38;2;58;0;0;48;2;0;0;0m▄\e[48;2;0;0;0m  \e[38;2;252;252;252;48;2;0;0;0m▄\e[38;2;255;255;255;48;2;0;0;0m▄▄\e[38;2;243;243;243;48;2;0;0;0m▄\e[48;2;0;0;0m  \e[38;2;5;5;5;48;2;0;0;0m▄\e[38;2;255;255;255;48;2;0;0;0m▄▄▄▄▄▄\e[48;2;0;0;0m  \e[38;2;90;90;90;48;2;0;0;0m▄\e[38;2;255;255;255;48;2;0;0;0m▄\e[48;2;0;0;0m    \e[38;2;255;255;255;48;2;0;0;0m▄▄▄\e[38;2;248;248;248;48;2;0;0;0m▄\e[48;2;0;0;0m   \e[38;2;255;255;255;48;2;0;0;0m▄\e[48;2;0;0;0m     \e[38;2;242;242;242;48;2;0;0;0m▄\e[38;2;255;255;255;48;2;0;0;0m▄▄▄▄\e[38;2;248;248;248;48;2;0;0;0m▄\e[48;2;0;0;0m    \e[m
\e[48;2;0;0;0m      \e[48;2;255;0;0m  \e[38;2;255;0;0;48;2;0;0;0m▄\e[48;2;0;0;0m    \e[48;2;255;0;0m \e[48;2;0;0;0m  \e[38;2;255;255;255;48;2;0;0;0m▄\e[38;2;0;0;0;48;2;255;255;255m▄\e[38;2;0;0;0;48;2;127;127;127m▄\e[48;2;0;0;0m  \e[38;2;0;0;0;48;2;249;249;249m▄\e[38;2;161;161;161;48;2;255;255;255m▄\e[38;2;255;255;255;48;2;0;0;0m▄\e[48;2;0;0;0m   \e[48;2;255;255;255m \e[48;2;0;0;0m     \e[48;2;255;255;255m \e[38;2;249;249;249;48;2;255;255;255m▄\e[38;2;240;240;240;48;2;0;0;0m▄\e[48;2;0;0;0m   \e[48;2;255;255;255m \e[48;2;0;0;0m  \e[38;2;0;0;0;48;2;102;102;102m▄\e[48;2;255;255;255m \e[48;2;0;0;0m  \e[48;2;255;255;255m \e[48;2;0;0;0m     \e[48;2;255;255;255m \e[48;2;66;66;66m \e[48;2;0;0;0m        \e[m
\e[48;2;0;0;0m      \e[48;2;255;0;0m \e[38;2;255;0;0;48;2;253;0;0m▄\e[38;2;219;0;0;48;2;255;0;0m▄\e[48;2;255;0;0m \e[38;2;255;0;0;48;2;0;0;0m▄\e[48;2;0;0;0m  \e[48;2;255;0;0m \e[48;2;0;0;0m  \e[48;2;255;255;255m \e[48;2;0;0;0m      \e[48;2;255;255;255m \e[48;2;0;0;0m   \e[48;2;255;255;255m \e[48;2;0;0;0m    \e[48;2;255;255;255m \e[38;2;0;0;0;48;2;156;156;156m▄\e[48;2;0;0;0m \e[48;2;255;255;255m \e[38;2;9;9;9;48;2;0;0;0m▄\e[48;2;0;0;0m  \e[48;2;255;255;255m \e[38;2;255;255;255;48;2;0;0;0m▄▄\e[38;2;255;255;255;48;2;132;132;132m▄\e[48;2;255;255;255m \e[48;2;0;0;0m  \e[48;2;255;255;255m \e[48;2;0;0;0m     \e[48;2;255;255;255m \e[38;2;255;255;255;48;2;66;66;66m▄\e[38;2;255;255;255;48;2;0;0;0m▄▄▄\e[48;2;0;0;0m     \e[m
\e[48;2;0;0;0m      \e[48;2;255;0;0m \e[38;2;134;0;0;48;2;142;0;0m▄\e[38;2;0;0;0;48;2;255;0;0m▄\e[38;2;255;0;0;48;2;94;0;0m▄\e[38;2;13;0;0;48;2;255;0;0m▄\e[48;2;255;0;0m \e[38;2;115;0;0;48;2;0;0;0m▄\e[48;2;255;0;0m \e[48;2;0;0;0m  \e[48;2;255;255;255m \e[38;2;255;255;255;48;2;0;0;0m▄\e[48;2;0;0;0m    \e[38;2;255;255;255;48;2;0;0;0m▄\e[38;2;77;77;77;48;2;255;255;255m▄\e[48;2;0;0;0m   \e[48;2;255;255;255m \e[48;2;0;0;0m   \e[38;2;255;255;255;48;2;4;4;4m▄\e[38;2;4;4;4;48;2;255;255;255m▄\e[38;2;0;0;0;48;2;255;255;255m▄▄▄\e[48;2;255;255;255m \e[48;2;0;0;0m  \e[48;2;255;255;255m \e[48;2;0;0;0m   \e[38;2;254;254;254;48;2;249;249;249m▄\e[38;2;178;178;178;48;2;185;185;185m▄\e[48;2;0;0;0m \e[48;2;255;255;255m \e[48;2;0;0;0m     \e[48;2;255;255;255m \e[48;2;66;66;66m \e[48;2;0;0;0m        \e[m
\e[48;2;0;0;0m      \e[48;2;255;0;0m \e[38;2;119;0;0;48;2;126;0;0m▄\e[48;2;0;0;0m \e[38;2;0;0;0;48;2;6;0;0m▄\e[38;2;88;0;0;48;2;255;0;0m▄\e[38;2;255;0;0;48;2;0;0;0m▄\e[38;2;0;0;0;48;2;255;0;0m▄\e[48;2;255;0;0m \e[48;2;0;0;0m   \e[38;2;0;0;0;48;2;243;243;243m▄\e[38;2;0;0;0;48;2;255;255;255m▄▄▄▄\e[38;2;0;0;0;48;2;84;84;84m▄\e[48;2;0;0;0m    \e[38;2;0;0;0;48;2;255;255;255m▄\e[48;2;0;0;0m   \e[38;2;0;0;0;48;2;255;255;255m▄\e[48;2;0;0;0m    \e[38;2;0;0;0;48;2;254;254;254m▄\e[38;2;0;0;0;48;2;203;203;203m▄\e[48;2;0;0;0m \e[38;2;0;0;0;48;2;255;255;255m▄▄▄▄▄\e[48;2;0;0;0m  \e[38;2;0;0;0;48;2;255;255;255m▄▄▄▄▄\e[48;2;0;0;0m \e[38;2;0;0;0;48;2;255;255;255m▄▄▄▄▄▄\e[48;2;0;0;0m    \e[m
\e[48;2;0;0;0m      \e[48;2;255;0;0m \e[38;2;105;0;0;48;2;110;0;0m▄\e[48;2;0;0;0m   \e[38;2;0;0;0;48;2;223;0;0m▄\e[38;2;253;0;0;48;2;255;0;0m▄\e[48;2;255;0;0m \e[48;2;0;0;0m                                                \e[m
\e[48;2;0;0;0m     \e[38;2;0;0;0;48;2;255;0;0m▄▄▄▄\e[48;2;0;0;0m    \e[38;2;0;0;0;48;2;255;0;0m▄\e[48;2;0;0;0m                                                \e[m
\n\n"
sleep 1 # to appreciate logo XD
echo -e "${CYAN}[$(date +'%d-%b-%Y %H:%M:%S')] Waiting for the database to come online...${RESET}"
while ! nc -zv -w30 notable-db 5432; do
    echo -e "${CYAN}[$(date +'%d-%M-%Y %H:%M:%S')] Waiting for the database to come online...${RESET}"
    sleep 5
done

echo -e "${CYAN}[$(date +'%d-%b-%Y %H:%M:%S')] Database service is online.${RESET}"
echo -e "${CYAN}[$(date +'%d-%b-%Y %H:%M:%S')] Starting up the application in due order...${RESET}"
echo -e "${CYAN}[$(date +'%d-%b-%Y %H:%M:%S')] EXECUTING ${BLUE}ARTISAN${CYAN} SCRIPTS${RESET}"

php artisan storage:link --quiet
php artisan key:generate --quiet
php artisan migrate --force --quiet
php artisan optimize:clear --quiet


echo -e "${CYAN}[$(date +'%d-%b-%Y %H:%M:%S')] STARTING ${BLUE}PHP-FPM${CYAN} NOW. OFF TO THE RACES!${RESET}"

exec "$@"
